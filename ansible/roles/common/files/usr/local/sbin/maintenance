#!/usr/bin/env bash

set -Eeuo pipefail
trap 'cleanup SIGINT' SIGINT
trap 'cleanup SIGTERM' SIGTERM
trap 'cleanup ERR' ERR
trap 'cleanup' EXIT

readonly MAINTENANCE_DIR="/usr/local/lib/maintenance.d"

usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") [-h] [-v]

Run system maintenance.

Available options:

-h, --help      Print this help and exit
-v, --verbose   Print script debug info
EOF
  exit
}

cleanup() {
  trap - SIGINT SIGTERM ERR EXIT
  if [[ "${1-}" == "SIGINT" ]]; then
    msg "\n${YELLOW}Interrupted${NOFORMAT}"
    exit 130
  elif [[ "${1-}" == "SIGTERM" ]]; then
    exit 143
  fi
}

# shellcheck disable=SC2034
setup_colors() {
  # Declare variables before conditional assignment
  local noformat red green orange blue purple cyan yellow

  if [[ -t 2 ]] && [[ -z "${NO_COLOR-}" ]] && [[ "${TERM-}" != "dumb" ]]; then
    noformat='\033[0m'
    red='\033[0;31m'
    green='\033[0;32m'
    orange='\033[0;33m'
    blue='\033[0;34m'
    purple='\033[0;35m'
    cyan='\033[0;36m'
    yellow='\033[1;33m'
  else
    noformat=''
    red=''
    green=''
    orange=''
    blue=''
    purple=''
    cyan=''
    yellow=''
  fi

  # Export as readonly globals
  readonly NOFORMAT="${noformat}"
  readonly RED="${red}"
  readonly GREEN="${green}"
  readonly ORANGE="${orange}"
  readonly BLUE="${blue}"
  readonly PURPLE="${purple}"
  readonly CYAN="${cyan}"
  readonly YELLOW="${yellow}"
}

msg() {
  echo >&2 -e "${1-}"
}
export -f msg

die() {
  local msg=$1
  local code=${2-1}
  msg "${RED}ERROR: ${msg}${NOFORMAT}"
  exit "$code"
}
export -f die

parse_params() {
  while :; do
    case "${1-}" in
      -h | --help) usage ;;
      -v | --verbose) set -x ;;
      -?*) die "Unknown option: $1" ;;
      *) break ;;
    esac
    shift
  done

  return 0
}

parse_params "$@"
setup_colors

if [[ ! -d "$MAINTENANCE_DIR" ]]; then
  die "Checks directory not found: $MAINTENANCE_DIR"
fi

errors=0

for item in "$MAINTENANCE_DIR"/*.sh; do
  [[ -e "$item" ]] || continue
  [[ -x "$item" ]] || continue

  msg "${YELLOW}Running: $(basename "$item")${NOFORMAT}"

  if ! "$item"; then
    ((errors++)) || true
  fi
done

if [[ $errors -gt 0 ]]; then
  die "$errors item(s) failed"
fi

msg "${GREEN}All items passed${NOFORMAT}"
